<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compare Plans - InsureMart</title>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --primary-color: #FF5B61;
      --secondary-color: #F59E0B;
      --accent-color: #FF4A50;
      --text-primary: #1E293B;
      --text-secondary: #86868B;
      --bg-primary: #FFFFFF;
      --bg-secondary: #F8FAFC;
      --border-color: #E5E5EA;
      --shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #FFF5F5 0%, #FFEBEB 100%);
      color: var(--text-primary);
      overflow-x: hidden;
    }

    .app {
      max-width: 428px;
      margin: 0 auto;
      background: linear-gradient(180deg, #FFF5F5 0%, #FFEBEB 100%);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      box-shadow: 0 0 30px rgba(255, 91, 97, 0.15);
      position: relative;
    }

    /* Fixed Header */
    .fixed-header {
      position: fixed;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 428px;
      background: var(--bg-primary);
      border-bottom: 1px solid var(--border-color);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
      z-index: 30;
    }

    .header-title {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }

    .back-btn-header {
      background: transparent;
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-primary);
      transition: background 0.2s;
      flex-shrink: 0;
    }

    .back-btn-header:hover {
      background: var(--bg-secondary);
    }

    .header-title-content {
      flex: 1;
    }

    .header-title-content h1 {
      font-size: 1.125rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }

    .header-title-content p {
      font-size: 0.75rem;
      color: var(--text-secondary);
    }

    .plan-selector {
      padding: 0.75rem 1rem;
    }

    .plan-nav {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 0.75rem;
    }

    .nav-btn {
      background: var(--bg-secondary);
      border: none;
      border-radius: 50%;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      color: var(--text-primary);
      transition: background 0.2s;
    }

    .nav-btn:hover {
      background: var(--border-color);
    }

    .plan-info-center {
      flex: 1;
      text-align: center;
    }

    .plan-color-bar {
      height: 6px;
      width: 64px;
      border-radius: 999px;
      margin: 0 auto 0.5rem;
    }

    .plan-name-display {
      font-size: 0.875rem;
      font-weight: 600;
      color: var(--text-primary);
      line-height: 1.3;
    }

    .highlight-actions {
      flex-shrink: 0;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      width: 80px;
    }

    .purchase-plan-btn,
    .remove-plan-btn {
      flex-shrink: 0;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 0.5rem;
      font-size: 0.75rem;
      color: var(--text-primary);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.25rem;
      width: 100%;
      height: 60px;
      flex-direction: column;
    }

    .purchase-plan-btn:hover,
    .remove-plan-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--primary-color);
    }

    .purchase-plan-btn i,
    .remove-plan-btn i {
      color: var(--text-primary);
    }

    .purchase-plan-btn i,
    .remove-plan-btn i {
      width: 16px;
      height: 16px;
    }

    .dots-indicator {
      display: flex;
      justify-content: center;
      gap: 0.5rem;
      margin-top: 0.75rem;
    }

    .dot {
      height: 8px;
      border-radius: 999px;
      border: none;
      cursor: pointer;
      transition: all 0.2s;
    }

    .dot.active {
      width: 24px;
    }

    .dot.inactive {
      width: 8px;
      background: var(--text-secondary);
      opacity: 0.3;
    }

    /* Spacer for fixed header */
    .header-spacer {
      height: 72px;
    }

    @media (max-width: 428px) {
      .header-spacer {
        height: 72px;
      }
    }

    /* Main Content */
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding-bottom: 100px;
    }

    /* Compare Plans Cards Container */
    .compare-plans-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      padding: 1rem;
    }

    .compare-plan-card {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1rem;
    }

    /* Highlight Card */
    .highlight-card {
      padding: 1rem;
      border-radius: 12px;
      background: white;
      color: var(--text-primary);
      border: 1px solid var(--border-color);
      display: flex;
      align-items: center;
      gap: 1rem;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    .highlight-icon {
      flex-shrink: 0;
      width: 25%;
      max-width: 80px;
      aspect-ratio: 1;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 1.25rem;
      overflow: hidden;
    }

    .highlight-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
      background: white;
      padding: 4px;
    }

    .highlight-icon span {
      display: flex;
      align-items: center;
      justify-content: center;
      width: 100%;
      height: 100%;
    }

    .highlight-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      min-width: 0;
    }

    .highlight-detail-item {
      display: flex;
      flex-direction: column;
    }

    .highlight-plan-name {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
      line-height: 1.2;
    }

    .highlight-plan-name {
      font-size: 1rem;
      font-weight: 700;
      margin-bottom: 0.25rem;
      line-height: 1.2;
      color: var(--text-primary);
    }

    .highlight-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.125rem;
    }

    .highlight-value {
      font-size: 0.9375rem;
      font-weight: 700;
      line-height: 1.2;
      color: var(--text-primary);
    }


    /* Feature Categories */
    .feature-categories {
      margin-top: 1rem;
      display: none;
    }

    .feature-categories.show {
      display: block;
    }

    .show-benefits-btn {
      width: calc(100% - 2rem);
      margin: 1rem;
      padding: 0.875rem 1rem;
      background: white;
      border: 1px solid var(--border-color);
      border-radius: 12px;
      color: var(--text-primary);
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .show-benefits-btn:hover {
      background: var(--bg-secondary);
      border-color: var(--primary-color);
      box-shadow: 0 2px 12px rgba(255, 91, 97, 0.15);
    }

    .show-benefits-btn i {
      width: 18px;
      height: 18px;
      transition: transform 0.2s;
    }

    .show-benefits-btn.active i {
      transform: rotate(180deg);
    }

    /* Compare Benefits Section */
    .compare-benefits-section {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 428px;
      padding: 1rem;
      background: white;
      border-top: 1px solid var(--border-color);
      z-index: 30;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
    }

    .compare-benefits-btn {
      width: 100%;
      padding: 0.875rem;
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 0.5rem;
    }

    .compare-benefits-btn:hover {
      background: #FF4A50;
    }

    .compare-benefits-btn i {
      width: 18px;
      height: 18px;
    }

    .category-item {
      border-bottom: 1px solid var(--border-color);
    }

    .category-features {
      padding: 0.5rem 1rem;
    }

    .feature-item {
      padding: 0.5rem 0;
      border-bottom: 1px solid var(--border-color);
    }

    .feature-item:last-child {
      border-bottom: none;
    }

    .feature-label {
      font-size: 0.75rem;
      color: var(--text-secondary);
      margin-bottom: 0.25rem;
    }

    .feature-value {
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-primary);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .feature-value.not-included {
      color: var(--text-secondary);
    }

    .feature-value.as-charged {
      color: #16a34a;
    }

    .check-icon {
      width: 16px;
      height: 16px;
      color: #16a34a;
    }

    .minus-icon {
      width: 16px;
      height: 16px;
      color: var(--text-secondary);
    }

    /* Fixed Bottom Actions */
    .fixed-bottom {
      position: fixed;
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 100%;
      max-width: 428px;
      background: var(--bg-primary);
      border-top: 1px solid var(--border-color);
      padding: 1rem;
      z-index: 30;
      box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.05);
    }

    .action-buttons {
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
    }

    .action-btn {
      width: 100%;
      padding: 0.875rem;
      border-radius: 8px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .action-btn-outline {
      background: transparent;
      border: 1px solid var(--primary-color);
      color: var(--primary-color);
    }

    .action-btn-outline:hover {
      background: rgba(234, 88, 12, 0.1);
    }

    .action-btn-primary {
      background: var(--primary-color);
      color: white;
    }

    .action-btn-primary:hover {
      background: #FF4A50;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 1rem;
      color: var(--text-secondary);
    }

    .empty-state i {
      width: 64px;
      height: 64px;
      margin-bottom: 1rem;
      opacity: 0.5;
      color: var(--text-secondary);
    }

    .empty-state p {
      font-size: 1rem;
      margin-bottom: 1rem;
    }

    .empty-state-btn {
      background: var(--primary-color);
      color: white;
      border: none;
      border-radius: 8px;
      padding: 0.875rem 1.5rem;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.2s;
    }

    .empty-state-btn:hover {
      background: #FF4A50;
    }

    /* Data Sharing Terms modal */
    .terms-modal {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1100;
    }

    .terms-modal.active {
      display: flex;
    }

    .terms-modal-content {
      width: calc(100% - 2rem);
      max-width: 400px;
      max-height: 70vh;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 12px 40px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    @media (max-width: 480px) {
      .terms-modal-content {
        max-width: 360px;
        margin: 0 1rem;
      }
    }

    @media (max-height: 700px) {
      .terms-modal-content {
        max-height: 65vh;
      }
      .terms-modal-header {
        padding: 0.85rem 1rem 0.5rem;
      }
      .terms-modal-body {
        padding: 0.75rem 1rem;
        font-size: 0.8rem;
      }
      .terms-modal-footer {
        padding: 0.6rem 1rem 0.9rem;
      }
    }

    .terms-modal-header {
      padding: 1.25rem 1.25rem 0.75rem;
      border-bottom: 1px solid #f2f2f7;
    }

    .terms-modal-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--text-primary);
      margin: 0;
    }

    .terms-modal-body {
      padding: 1rem 1.25rem;
      overflow-y: auto;
      font-size: 0.875rem;
      line-height: 1.5;
      color: var(--text-primary);
      background: #fafafa;
    }

    .terms-modal-body p {
      margin-bottom: 0.75rem;
    }

    .terms-modal-footer {
      padding: 0.75rem 1.25rem 1.25rem;
      display: flex;
      gap: 0.75rem;
      border-top: 1px solid #f2f2f7;
      background: #fff;
    }

    .terms-btn {
      flex: 1;
      padding: 0.75rem;
      border-radius: 999px;
      border: 1px solid #e5e5ea;
      background: #f5f5f7;
      color: var(--text-primary);
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
    }

    .terms-btn.primary {
      background: var(--primary-color);
      border-color: var(--primary-color);
      color: #fff;
    }

    .terms-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none;
    }

    .terms-btn.primary:disabled {
      background: #ccc;
      border-color: #ccc;
      color: #999;
    }
  </style>
  </head>
  <body>
    <div class="app">
      <!-- Fixed Header -->
      <div class="fixed-header">
        <div class="header-title">
          <button class="back-btn-header"
            onclick="window.location.href='medical-plan.html'"
            aria-label="Back">
            <i data-lucide="arrow-left"></i>
          </button>
          <div class="header-title-content">
            <h1>Compare Plans</h1>
            <p id="plans-count">Swipe to compare 0 plans</p>
          </div>
        </div>
        <div class="plan-selector" id="plan-selector" style="display: none;">
          <div class="plan-nav">
            <button class="nav-btn" onclick="goToPrevious()"
              aria-label="Previous plan">
              <i data-lucide="chevron-left"></i>
            </button>
            <div class="plan-info-center">
              <div class="plan-color-bar" id="plan-color-bar"></div>
              <p class="plan-name-display" id="plan-name-display"></p>
            </div>
            <button class="nav-btn" onclick="goToNext()" aria-label="Next plan">
              <i data-lucide="chevron-right"></i>
            </button>
          </div>
          <div class="dots-indicator" id="dots-indicator"></div>
        </div>
      </div>

      <!-- Spacer for fixed header -->
      <div class="header-spacer"></div>

      <!-- Main Content -->
      <main class="main-content" id="main-content">
        <!-- Content will be rendered here -->
      </main>

      <!-- Compare Benefits Button -->
      <div class="compare-benefits-section" id="compare-benefits-section" style="display: none;">
        <button class="compare-benefits-btn" onclick="window.location.href='compare-benefits.html'">
          <i data-lucide="git-compare"></i>
          <span>Compare Benefits</span>
        </button>
      </div>


      <!-- Data Sharing Terms Modal -->
      <div class="terms-modal" id="terms-modal">
        <div class="terms-modal-content">
          <div class="terms-modal-header">
            <h3 class="terms-modal-title">Data Sharing Terms &amp;
              Conditions</h3>
          </div>
          <div class="terms-modal-body">
            <p><strong>By agreeing to these terms, you expressly acknowledge and
                agree to the following:</strong></p>
            <p>
              You hereby expressly authorize <strong></strong> to share your
              Personal Data with the Insurance Provider
              and Insurance Agency (hereinafter referred to as "Partner"). You
              further consent to the Partner's Privacy Policy
              and acknowledge that your Personal Data will be used, processed,
              and handled in accordance with the Partner's
              Privacy Policy.
            </p>
            <p>
              You acknowledge that once your Personal Data is shared with the
              Partner, the Partner will have sole and full
              control over the copy of your Personal Data, and you will be
              required to contact the Partner directly for any
              matters related to your Personal Data.
            </p>
            <p>
              You expressly consent to the transfer of your Personal Data to a
              location outside Malaysia, subject to the terms
              outlined in the Partner's Privacy Policy.
            </p>
            <p>
              <strong></strong> shall be released from all obligations and
              responsibilities related to the copy of
              Personal Data shared with the Partner. For clarity,
              <strong></strong> will ensure that any Personal Data
              retained under its control is processed in accordance with
              <strong></strong>'s Privacy Policy and
              applicable laws.
            </p>
            <p>
              You may withdraw your consent for further disclosure of your
              Personal Data at any time by submitting a request to
              <a href="mailto:support@mdeal.com.my"></a>. However, such
              withdrawal may result in the Partner
              or <strong></strong> declining, refusing, or making services
              inaccessible to you. Please note that any
              withdrawal of consent will not affect Personal Data previously
              shared, for which you must contact the Partner
              directly.
            </p>
          </div>
          <div class="terms-modal-footer">
            <button type="button" class="terms-btn"
              onclick="closeTermsModal()">Close</button>
            <button type="button" id="accept-terms-btn"
              class="terms-btn primary" onclick="acceptTermsAndProceed()"
              disabled>I accept</button>
          </div>
        </div>
      </div>
    </div>

    <script>
    lucide.createIcons();

    // Available medical plans (should mirror medical-plan.html)
    const medicalPlans = [
      {
        name: 'Zurich ZMedProtect',
        coverage: 'RM 1,000,000',
        price: 350,
        type: 'normal',
        minAge: 0,
        maxAge: 80,
        gender: 'both',
        color: '#0ea5e9',
        list: ['Zurich ZMedProtect Plan 1', 'Zurich ZMedProtect Plan 2', 'Zurich ZMedProtect Plan 3'],
        logo: 'zurich-logo.svg',
        planFeatures: {
          overallAnnualLimit: 'RM 1,000,000',
          roomAndBoard: 'RM 300/day',
          ambulanceFee: 'As Charged',
          anaesthetistFee: 'As Charged',
          dailyCashAllowance: 'RM 80',
          daySurgery: 'As Charged',
          emergencyOutpatient: 'As Charged (Max 30 days)',
          entryAge: 'Age 0 - Age 80',
          hospitalSupplies: 'As Charged',
          inHospitalPhysician: 'As Charged',
          intensiveCareUnit: 'As Charged (Max 30 days)',
          operatingTheatre: 'As Charged',
          outpatientCancer: 'As Charged',
          outpatientKidney: 'As Charged',
          postHospitalisation: 'As Charged (Max 60 days)',
          preHospitalisation: 'As Charged (Max 60 days)',
          nurseAndBoard: 'RM 150',
          surgicalFees: 'As Charged',
          compassionateAllowance: '-',
          emergencyDental: '-',
          homeNursingCare: '-',
          organTransplant: '-',
        },
      },
      {
        name: 'Allianz Medicure',
        coverage: 'RM 500,000',
        price: 949,
        type: 'normal',
        minAge: 0,
        maxAge: 80,
        gender: 'both',
        color: '#2563eb',
        list: ['Allianz Medicure Plan 1', 'Allianz Medicure Plan 2', 'Allianz Medicure Plan 3'],
        logo: 'Allianz.svg',
        planFeatures: {
          overallAnnualLimit: 'RM 500,000',
          roomAndBoard: 'RM 250/day',
          ambulanceFee: 'As Charged',
          anaesthetistFee: 'As Charged',
          dailyCashAllowance: 'RM 50',
          daySurgery: 'As Charged',
          emergencyOutpatient: 'As Charged (Max 30 days)',
          entryAge: 'Age 0 - Age 80',
          hospitalSupplies: 'As Charged',
          inHospitalPhysician: 'As Charged',
          intensiveCareUnit: 'As Charged (Max 20 days)',
          operatingTheatre: 'As Charged',
          outpatientCancer: 'As Charged',
          outpatientKidney: 'As Charged',
          postHospitalisation: 'As Charged (Max 30 days)',
          preHospitalisation: 'As Charged (Max 30 days)',
          nurseAndBoard: 'RM 120',
          surgicalFees: 'As Charged',
          compassionateAllowance: '-',
          emergencyDental: '-',
          homeNursingCare: '-',
          organTransplant: '-',
        },
      },
      {
        name: 'SmartCare Optimum Plus Plan 1',
        coverage: 'RM 2,100,000',
        price: 1441,
        type: 'normal',
        minAge: 0,
        maxAge: 80,
        gender: 'both',
        color: '#16a34a',
        list: ['SmartCare Optimum Plus Plan 1', 'SmartCare Optimum Plus Plan 2', 'SmartCare Optimum Plus Plan 3'],
        logo: 'Assicurazioni_Generali_logo.png',
        planFeatures: {
          overallAnnualLimit: 'RM 2,100,000',
          roomAndBoard: 'RM 600/day',
          ambulanceFee: 'As Charged',
          anaesthetistFee: 'As Charged',
          dailyCashAllowance: 'RM 120',
          daySurgery: 'As Charged',
          emergencyOutpatient: 'As Charged (Max 60 days)',
          entryAge: 'Age 0 - Age 80',
          hospitalSupplies: 'As Charged',
          inHospitalPhysician: 'As Charged',
          intensiveCareUnit: 'As Charged (Max 45 days)',
          operatingTheatre: 'As Charged',
          outpatientCancer: 'RM 50,000/year',
          outpatientKidney: 'RM 20,000/year',
          postHospitalisation: 'As Charged (Max 90 days)',
          preHospitalisation: 'As Charged (Max 60 days)',
          nurseAndBoard: 'RM 200',
          surgicalFees: 'As Charged',
          compassionateAllowance: 'RM 1,000',
          emergencyDental: 'As Charged',
          homeNursingCare: 'RM 150',
          organTransplant: 'RM 30,000',
        },
      },
    ];

    const featureLabels = {
      overallAnnualLimit: 'Overall Annual Limit',
      roomAndBoard: 'Room & Board',
      ambulanceFee: 'Ambulance Fee',
      anaesthetistFee: 'Anaesthetist Fee',
      dailyCashAllowance: 'Daily Cash Allowance at Gov Hospital',
      daySurgery: 'Day Surgery',
      emergencyOutpatient: 'Emergency Accidental Outpatient Treatment',
      entryAge: 'Entry Age',
      hospitalSupplies: 'Hospital Supplies and Services',
      inHospitalPhysician: 'In-Hospital Physician Visit',
      intensiveCareUnit: 'Intensive Care Unit (ICU)',
      operatingTheatre: 'Operating Theatre',
      outpatientCancer: 'Outpatient Cancer Treatment',
      outpatientKidney: 'Outpatient Kidney Dialysis Treatment',
      postHospitalisation: 'Post-Hospitalisation Benefit',
      preHospitalisation: 'Pre-Hospitalisation Benefit',
      nurseAndBoard: 'Nurse and Board',
      surgicalFees: 'Surgical Fees',
      compassionateAllowance: 'Compassionate Allowance',
      emergencyDental: 'Emergency Accidental Dental Care',
      homeNursingCare: 'Home Nursing Care',
      organTransplant: 'Organ Transplant',
    };

    const featureCategories = [
      {
        name: 'Core Benefits',
        features: ['overallAnnualLimit', 'roomAndBoard', 'nurseAndBoard', 'surgicalFees', 'intensiveCareUnit'],
      },
      {
        name: 'Hospital Services',
        features: ['operatingTheatre', 'hospitalSupplies', 'inHospitalPhysician', 'anaesthetistFee', 'ambulanceFee', 'daySurgery'],
      },
      {
        name: 'Outpatient',
        features: ['emergencyOutpatient', 'outpatientCancer', 'outpatientKidney'],
      },
      {
        name: 'Pre & Post Hospital',
        features: ['preHospitalisation', 'postHospitalisation'],
      },
      {
        name: 'Additional Benefits',
        features: ['dailyCashAllowance', 'compassionateAllowance', 'emergencyDental', 'homeNursingCare', 'organTransplant'],
      },
      {
        name: 'Eligibility',
        features: ['entryAge'],
      },
    ];

    let currentPlanIndex = 0;
    let comparePlans = [];
    let benefitsVisible = false;

    // Get plans from comparison list
    function getComparePlans() {
      const compareList = JSON.parse(sessionStorage.getItem('comparePlans') || '[]');
      const plans = compareList.map(item => {
        // First try to find plan by exact name match
        let plan = medicalPlans.find(p => p.name === item.name);
        
        // If not found, try to find plan where item.name is in the plan's list (variant)
        if (!plan) {
          plan = medicalPlans.find(p => p.list && p.list.includes(item.name));
        }
        
        if (plan) {
          // Override the name with the stored variant name if it's different
          return { ...plan, name: item.name, compareIndex: item.index };
        }
        return null;
      }).filter(plan => plan !== null);
      
      // Sort by price (lowest to highest)
      return plans.sort((a, b) => {
        const priceA = a.price || 0;
        const priceB = b.price || 0;
        return priceA - priceB;
      });
    }

    // Render value
    function renderValue(value) {
      if (value === '-') {
        return `
          <div class="feature-value not-included">
            <i data-lucide="minus" class="minus-icon"></i>
            <span>Not included</span>
          </div>
        `;
      }
      if (value === 'As Charged') {
        return `
          <div class="feature-value as-charged">
            <i data-lucide="check" class="check-icon"></i>
            <span>As Charged</span>
          </div>
        `;
      }
      return `<span class="feature-value">${value}</span>`;
    }

    // Render comparison
    function renderComparison() {
      comparePlans = getComparePlans();
      const mainContent = document.getElementById('main-content');
      const planSelector = document.getElementById('plan-selector');
      const plansCount = document.getElementById('plans-count');

      // Hide swipe navigation
      if (planSelector) {
        planSelector.style.display = 'none';
      }

      // If no plans in sessionStorage, show empty state
      if (comparePlans.length === 0) {
        if (plansCount) {
          plansCount.textContent = 'Compare 0 plans';
        }
        mainContent.innerHTML = `
          <div class="empty-state">
            <i data-lucide="search-x"></i>
            <p>No plans selected for comparison yet.</p>
            <button class="empty-state-btn" onclick="window.location.href='medical-plan.html'">
              Add plans to compare
            </button>
          </div>
        `;
        lucide.createIcons();
        return;
      }

      if (plansCount) {
        plansCount.textContent = `Comparing ${comparePlans.length} plan${comparePlans.length > 1 ? 's' : ''}`;
      }
      
      // Show Compare Benefits button if there are plans
      const compareBenefitsSection = document.getElementById('compare-benefits-section');
      if (compareBenefitsSection && comparePlans.length > 0) {
        compareBenefitsSection.style.display = 'block';
      }
      
      renderAllPlans();
    }

    // Render all plans as cards
    function renderAllPlans() {
      if (comparePlans.length === 0) return;

      const mainContent = document.getElementById('main-content');
      
      const plansHTML = comparePlans.map((plan, index) => {
        const price = plan.price || 0;
        const priceFormatted = `RM ${price.toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        const planInitials = plan.name.substring(0, 2).toUpperCase();

        return `
          <div class="compare-plan-card">
            <div class="highlight-card">
              <div class="highlight-icon">
                ${plan.logo ? `
                  <img src="insurance-img/${plan.logo}" alt="${plan.name} logo"
                    onerror="this.style.display='none'; this.parentElement.innerHTML='<span>${planInitials}</span>';">
                ` : `
                  <span>${planInitials}</span>
                `}
              </div>
              <div class="highlight-details">
                <p class="highlight-plan-name">${plan.name}</p>
                <div class="highlight-detail-item">
                  <p class="highlight-label">Annual Premium</p>
                  <p class="highlight-value">${priceFormatted}</p>
                </div>
                <div class="highlight-detail-item">
                  <p class="highlight-label">Annual Limit</p>
                  <p class="highlight-value">${plan.planFeatures?.overallAnnualLimit || plan.coverage}</p>
                </div>
              </div>
              <div class="highlight-actions">
                <button class="purchase-plan-btn" onclick="purchasePlan('${plan.name}')" title="Purchase">
                  <i data-lucide="shopping-cart"></i>
                  <span style="font-size: 0.625rem;">Purchase</span>
                </button>
                <button class="remove-plan-btn" onclick="removePlanFromCompare('${plan.name}')" title="Remove from Compare">
                  <i data-lucide="x"></i>
                  <span style="font-size: 0.625rem;">Remove</span>
                </button>
              </div>
            </div>
          </div>
        `;
      }).join('');

      mainContent.innerHTML = plansHTML;
      lucide.createIcons();
    }


    // Toggle benefits visibility
    function toggleBenefits() {
      benefitsVisible = !benefitsVisible;
      const featureCategories = document.getElementById('feature-categories');
      const showBtn = document.getElementById('show-benefits-btn');
      
      if (featureCategories && showBtn) {
        const btnSpan = showBtn.querySelector('span');
        
        if (benefitsVisible) {
          featureCategories.classList.add('show');
          showBtn.classList.add('active');
          if (btnSpan) btnSpan.textContent = 'Hide Benefits Details';
        } else {
          featureCategories.classList.remove('show');
          showBtn.classList.remove('active');
          if (btnSpan) btnSpan.textContent = 'Show Benefits Details';
        }
        
        // Recreate icons after text change
        lucide.createIcons();
      }
    }

    // Purchase plan
    function purchasePlan(planName) {
      // Store the plan name for purchase flow
      sessionStorage.setItem('selectedPlanName', planName);
      // Show Data Sharing Terms modal first (same as medical-plan.html)
      const modal = document.getElementById('terms-modal');
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Disable accept button initially
        const acceptBtn = document.getElementById('accept-terms-btn');
        if (acceptBtn) {
          acceptBtn.disabled = true;
        }
        
        // Set up scroll detection
        const modalBody = modal.querySelector('.terms-modal-body');
        if (modalBody) {
          // Reset scroll position
          modalBody.scrollTop = 0;
          
          // Check scroll position function
          const checkScrollPosition = () => {
            const scrollTop = modalBody.scrollTop;
            const scrollHeight = modalBody.scrollHeight;
            const clientHeight = modalBody.clientHeight;
            
            // Check if scrolled to bottom (with 10px tolerance)
            const isAtBottom = scrollTop + clientHeight >= scrollHeight - 10;
            
            if (acceptBtn) {
              acceptBtn.disabled = !isAtBottom;
            }
          };
          
          // Add scroll event listener
          modalBody.addEventListener('scroll', checkScrollPosition);
          
          // Check initial state (in case content is short and already fully visible)
          setTimeout(checkScrollPosition, 100);
        }
      }
    }

    // Remove plan from comparison
    function removePlanFromCompare(planName) {
      if (confirm(`Remove "${planName}" from comparison?`)) {
        let compareList = JSON.parse(sessionStorage.getItem('comparePlans') || '[]');
        compareList = compareList.filter(item => item.name !== planName);
        sessionStorage.setItem('comparePlans', JSON.stringify(compareList));
        
        // Adjust current index if needed
        if (currentPlanIndex >= compareList.length) {
          currentPlanIndex = Math.max(0, compareList.length - 1);
        }
        
        // Re-render comparison
        renderComparison();
      }
    }

    // Action functions
    function submitApplication() {
      // Show Data Sharing Terms modal first (same as medical-plan.html)
      const modal = document.getElementById('terms-modal');
      if (modal) {
        modal.classList.add('active');
        document.body.style.overflow = 'hidden';
        
        // Disable accept button initially
        const acceptBtn = document.getElementById('accept-terms-btn');
        if (acceptBtn) {
          acceptBtn.disabled = true;
        }
        
        // Set up scroll detection
        const modalBody = modal.querySelector('.terms-modal-body');
        if (modalBody) {
          // Reset scroll position
          modalBody.scrollTop = 0;
          
          // Check scroll position function
          const checkScrollPosition = () => {
            const scrollTop = modalBody.scrollTop;
            const scrollHeight = modalBody.scrollHeight;
            const clientHeight = modalBody.clientHeight;
            
            // Check if scrolled to bottom (with 10px tolerance)
            const isAtBottom = scrollTop + clientHeight >= scrollHeight - 10;
            
            if (acceptBtn) {
              acceptBtn.disabled = !isAtBottom;
            }
          };
          
          // Add scroll event listener
          modalBody.addEventListener('scroll', checkScrollPosition);
          
          // Check initial state (in case content is short and already fully visible)
          setTimeout(checkScrollPosition, 100);
        }
      }
    }

    function closeTermsModal() {
      const modal = document.getElementById('terms-modal');
      if (modal) {
        modal.classList.remove('active');
        document.body.style.overflow = '';
        // Reset scroll position and button state
        const modalBody = modal.querySelector('.terms-modal-body');
        const acceptBtn = document.getElementById('accept-terms-btn');
        if (modalBody) {
          modalBody.scrollTop = 0;
          // Remove scroll event listener by cloning and replacing
          const newBody = modalBody.cloneNode(true);
          modalBody.parentNode.replaceChild(newBody, modalBody);
        }
        if (acceptBtn) {
          acceptBtn.disabled = true;
        }
      }
    }

    function acceptTermsAndProceed() {
      // Store selected plan information
      if (comparePlans.length > 0 && currentPlanIndex >= 0 && currentPlanIndex < comparePlans.length) {
        const currentPlan = comparePlans[currentPlanIndex];
        if (currentPlan) {
          // Store plan name in sessionStorage for purchase pages
          sessionStorage.setItem('selectedPlanName', currentPlan.name);
        }
      }
      
      // Continue to purchase flow
      closeTermsModal();
      window.location.href = 'purchase-step-1.html';
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      renderComparison();
    });
  </script>
  </body>
</html>
